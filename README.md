# The Civics Center Web Services
The purpose of this project is to provide additional services to [The Civics Center](https://www.thecivicscenter.org/) website beyond what is possible and reasonable with Squarespace. 

## DNS Proxying
Cloudflare will serve as a DNS proxy and will delegate requests for marketing pages such as /about to the SquareSpace site and request to services in this project such as those listed in [routes](#routes) to this app. 


## Routes

- /admin - This page will allow TCC content managers to be able to log in and edit text and images on the pages. This route is built with a content management system called [Payload](https://payloadcms.com/).

- /vr-rules - A page that shows national voter preregistration ages on a chlorpleth of a USA map. Users will be able select states to drill down to state specific pages.

- /vr-rules/{state-name} - Each state will have a path that displays details about voter registration and pre-registion in that state such as:
  - Registration and Pre-registration age
  - Registration id requirements
  - Upcomming statewide deadlines and elections
  - Data showing the number of 18 year olds registered to vote in the state compared to age 45+.
  - Links to substack articles TCC has written about the state
  - Call to action to register to vote 
  - Call to action to be a drive leader at your High School
  - Options to share 
  - Social Cards

- /leaderboard - (future) Currently the TCC leaderboard lives in GoogleCloud at the subdomain https://leaderboard.thecivicscenter.org. The plan is to 

## Architecture

This app is a **Next.js** site with **Payload CMS** as the admin/CMS layer, built for **Cloudflare Workers** via **OpenNext**. It originated from the [Payload Cloudflare Template](https://github.com/payloadcms/payload/tree/main/templates/with-cloudflare-d1).

**Stack summary:**

- **Runtime:** [Cloudflare Worker](https://workers.cloudflare.com/) (serverless).
- **Framework:** [Next.js](https://nextjs.org/docs) (App Router). Payload is mounted under `(payload)` route groups; see `src/app/(payload)/` and `src/app/(frontend)/`.
- **Build for Workers:** [OpenNext for Cloudflare](https://opennext.js.org/docs/cloudflare) (`@opennextjs/cloudflare`). The Next.js app is built and then compiled to a Worker entrypoint; config is in `open-next.config.ts`. The Worker entrypoint and assets are in `.open-next/` (generated by the build).
- **Database:** [Cloudflare D1](https://developers.cloudflare.com/d1/) (SQLite). Payload uses `@payloadcms/db-d1-sqlite`. The D1 database and binding are defined in `wrangler.jsonc`.
- **Media storage:** [Cloudflare R2](https://developers.cloudflare.com/r2/). Payload uses `@payloadcms/storage-r2`; uploads are stored in the R2 bucket configured in `wrangler.jsonc`.

**Deployment requirement:** Use the **Paid Workers** plan. The bundle exceeds the free tier [size limits](https://developers.cloudflare.com/workers/platform/limits/#worker-size) (3 MB).

## Local development

1. **Prerequisites:** Node (see `engines` in `package.json`), pnpm, and a Cloudflare account.

2. **Install and authenticate:**
   ```bash
   pnpm install
   pnpm wrangler login
   ```

3. **Run the app:**
   ```bash
   pnpm dev
   ```
   Next.js runs locally; Wrangler provides local bindings to your remote D1 and R2 resources (see [Wrangler](https://developers.cloudflare.com/workers/wrangler/)).

4. **Optional:** To avoid stale build artifacts, use `pnpm run devsafe` (clears `.next` and `.open-next` before starting).

## How the project is structured (Payload + Next)

- **Payload config:** `src/payload.config.ts` — collections, db adapter (D1), storage (R2), admin path, etc.
- **Collections:** Defined in `src/collections/` (e.g. `Users.ts`, `Media.ts`). See [Payload Collections](https://payloadcms.com/docs/configuration/collections) to add or change content models.
- **Users:** Auth-enabled collection for admin access. [Payload Authentication](https://payloadcms.com/docs/authentication/overview#authentication-overview) and [Auth Example](https://github.com/payloadcms/payload/tree/main/examples/auth).
- **Media:** Upload collection; files go to the R2 bucket. You can put a CDN in front of R2 for the frontend if needed.
- **Generated types:** After changing collections or globals, run `pnpm run generate:types` and, if you add or change admin UI components, `pnpm run generate:importmap`. Types are written to `src/payload-types.ts`.
- **D1:** No traditional connection string; the Worker uses the D1 binding. For [D1 read replicas](https://payloadcms.com/docs/database/sqlite#d1-read-replicas), set `readReplicas: 'first-primary'` in the D1 adapter and enable replicas in the Cloudflare dashboard.

## Deploying to Cloudflare

1. **Create migrations** (when you change Payload schema):
   ```bash
   pnpm payload migrate:create
   ```

2. **Deploy** (migrations first, then the app):
   ```bash
   pnpm run deploy
   ```
   This runs:
   - `deploy:database` — runs Payload migrations against production and then `wrangler d1 execute ... PRAGMA optimize` for the configured D1 DB.
   - `deploy:app` — `opennextjs-cloudflare build` then `opennextjs-cloudflare deploy`. Requires `CLOUDFLARE_ENV` if you use env-specific config in `wrangler.jsonc` (e.g. `CLOUDFLARE_ENV=staging pnpm run deploy`).

3. **Preview build locally:** `pnpm run preview` (builds and runs the Worker locally with your env bindings).

4. **Logs:** Workers log output is off by default (quota). Enable in the [Cloudflare dashboard](https://developers.cloudflare.com/workers/observability/logs/workers-logs/#enable-workers-logs).

## Known issues and constraints

- **GraphQL:** Full GraphQL support on Workers can be limited; see [workerd issue #5175](https://github.com/cloudflare/workerd/issues/5175). Prefer REST or test GraphQL after deployment.
- **Bundle size:** Stay within the [Worker size limit](https://developers.cloudflare.com/workers/platform/limits/#worker-size); large dependencies can push you over. Paid Workers plan is required for this project.

## Where to get more information

- **Payload:** [Docs](https://payloadcms.com/docs), [LLM context](https://payloadcms.com/llms-full.txt), [Discord](https://discord.com/invite/payload), [GitHub discussions](https://github.com/payloadcms/payload/discussions).
- **OpenNext (Cloudflare):** [OpenNext Cloudflare docs](https://opennext.js.org/docs/cloudflare).
- **Next.js:** [Next.js documentation](https://nextjs.org/docs).
- **Cloudflare Workers / D1 / R2:** [Workers](https://developers.cloudflare.com/workers/), [D1](https://developers.cloudflare.com/d1/), [R2](https://developers.cloudflare.com/r2/), [Wrangler](https://developers.cloudflare.com/workers/wrangler/).
